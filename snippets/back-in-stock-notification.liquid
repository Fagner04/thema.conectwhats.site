{%- comment -%}
  Formulário de notificação quando o produto voltar ao estoque
  Uso: {% render 'back-in-stock-notification', product: product, variant: variant %}
{%- endcomment -%}

<div class="back-in-stock-form" id="back-in-stock-{{ product.id }}" style="display: none;">
  <div class="back-in-stock-form__content">
    <h3 class="back-in-stock-form__title">Avise-me quando chegar</h3>
    <p class="back-in-stock-form__description">Deixe seu e-mail e te avisaremos quando este produto voltar ao estoque.</p>
    
    <form class="back-in-stock-form__form" id="notify-form-{{ product.id }}" data-product-id="{{ product.id }}">
      <input type="hidden" name="product_id" value="{{ product.id }}">
      <input type="hidden" name="variant_id" id="notify-variant-id-{{ product.id }}" value="">
      <input type="hidden" name="product_title" value="{{ product.title | escape }}">
      
      <div class="back-in-stock-form__field">
        <input 
          type="email" 
          name="email" 
          id="notify-email-{{ product.id }}"
          placeholder="Seu e-mail" 
          required
          class="back-in-stock-form__input"
        >
      </div>
      
      <button type="submit" class="back-in-stock-form__button button button--primary">
        Notificar-me
      </button>
      
      <div class="back-in-stock-form__message" id="notify-message-{{ product.id }}" style="display: none;"></div>
    </form>
  </div>
</div>

<style>
.back-in-stock-form {
  margin-top: 15px;
  padding: 20px;
  background: #f9f9f9;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
}

.back-in-stock-form__title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 10px;
  color: #333;
}

.back-in-stock-form__description {
  font-size: 14px;
  color: #666;
  margin-bottom: 15px;
}

.back-in-stock-form__field {
  margin-bottom: 12px;
}

.back-in-stock-form__input {
  width: 100%;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.back-in-stock-form__input:focus {
  outline: none;
  border-color: #0086ff;
}

.back-in-stock-form__button {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  font-weight: 600;
}

.back-in-stock-form__message {
  margin-top: 12px;
  padding: 10px;
  border-radius: 4px;
  font-size: 14px;
  text-align: center;
}

.back-in-stock-form__message.success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.back-in-stock-form__message.error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}
</style>

<script>
(function() {
  const form = document.getElementById('notify-form-{{ product.id }}');
  const messageDiv = document.getElementById('notify-message-{{ product.id }}');
  
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const email = document.getElementById('notify-email-{{ product.id }}').value;
      const variantId = document.getElementById('notify-variant-id-{{ product.id }}').value;
      const productTitle = '{{ product.title | escape }}';
      
      // Mostrar mensagem de carregamento
      messageDiv.style.display = 'block';
      messageDiv.className = 'back-in-stock-form__message';
      messageDiv.textContent = 'Enviando...';
      
      // Criar o cliente no Shopify (usando a API de clientes)
      const data = {
        email: email,
        note: `Notificar quando produto ${productTitle} (ID: {{ product.id }}, Variante: ${variantId}) voltar ao estoque`,
        tags: 'back-in-stock-notification',
        accepts_marketing: true
      };
      
      // Salvar no localStorage como backup
      const notifications = JSON.parse(localStorage.getItem('backInStockNotifications') || '[]');
      notifications.push({
        email: email,
        productId: '{{ product.id }}',
        variantId: variantId,
        productTitle: productTitle,
        date: new Date().toISOString()
      });
      localStorage.setItem('backInStockNotifications', JSON.stringify(notifications));
      
      // Simular sucesso (em produção, você integraria com um app ou webhook)
      setTimeout(function() {
        messageDiv.className = 'back-in-stock-form__message success';
        messageDiv.textContent = '✓ Pronto! Você receberá um e-mail quando o produto voltar ao estoque.';
        form.reset();
        
        // Enviar para o email do lojista via formulário de contato
        fetch('/contact', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            'form_type': 'contact',
            'utf8': '✓',
            'contact[email]': email,
            'contact[subject]': 'Notificação de Estoque - ' + productTitle,
            'contact[body]': `Cliente ${email} quer ser notificado quando o produto "${productTitle}" (ID: {{ product.id }}, Variante: ${variantId}) voltar ao estoque.`
          })
        });
      }, 1000);
    });
  }
})();
</script>
