{%- comment -%} BARRA DE PROGRESSO ATACADO + PRE√áOS + C√ÅLCULO TOTAL {%- endcomment -%}
{%- assign wholesale_min = 6 -%}
{%- comment -%} ‚Üë Altere para a quantidade m√≠nima configurada na ConectWhats {%- endcomment -%}
{%- assign total_items = cart.item_count -%}
{%- assign progress = total_items | times: 100 | divided_by: wholesale_min -%}
{%- if progress > 100 -%}
  {%- assign progress = 100 -%}
{%- endif -%}
{%- assign remaining = wholesale_min | minus: total_items -%}
{%- assign wholesale_active = false -%}
{%- if remaining <= 0 -%}
  {%- assign wholesale_active = true -%}
{%- endif -%}

{%- comment -%} CALCULAR TOTAL COM PRE√áOS DE ATACADO {%- endcomment -%}
{%- assign wholesale_total = 0 -%}
{%- assign original_total = 0 -%}
{%- assign has_wholesale_prices = false -%}

{%- if wholesale_active -%}
  {%- for item in cart.items -%}
    {%- assign ws_price = item.product.metafields.custom.wholesale_price.value -%}
    {%- if ws_price -%}
      {%- assign has_wholesale_prices = true -%}
      {%- assign item_ws_total = ws_price | times: 100 | times: item.quantity -%}
      {%- assign wholesale_total = wholesale_total | plus: item_ws_total -%}
      {%- assign original_total = original_total | plus: item.final_line_price -%}
    {%- else -%}
      {%- assign wholesale_total = wholesale_total | plus: item.final_line_price -%}
      {%- assign original_total = original_total | plus: item.final_line_price -%}
    {%- endif -%}
  {%- endfor -%}
  
  {%- assign savings = original_total | minus: wholesale_total -%}
{%- endif -%}

<style>
.cw-cart-price { 
  display: flex; 
  align-items: center; 
  gap: 6px; 
  flex-wrap: wrap; 
  margin: 2px 0; 
}
.cw-price-wholesale { 
  color: #16A34A; 
  font-weight: 700; 
  font-size: 14px; 
}
.cw-price-original { 
  color: #9CA3AF; 
  text-decoration: line-through; 
  font-size: 12px; 
}
.cw-badge-atacado { 
  display: inline-flex; 
  align-items: center; 
  gap: 2px; 
  background: #DCFCE7; 
  color: #15803D; 
  font-size: 10px; 
  font-weight: 600; 
  padding: 1px 6px; 
  border-radius: 4px; 
}
.cw-total-savings {
  background: #DCFCE7;
  border: 1px solid #86EFAC;
  border-radius: 6px;
  padding: 8px 12px;
  margin: 8px 0;
  text-align: center;
}
.cw-total-savings-text {
  font-size: 11px;
  color: #166534;
  margin: 0 0 4px;
}
.cw-total-savings-amount {
  font-size: 16px;
  font-weight: 700;
  color: #15803D;
  margin: 0;
}
</style>

<div class="cw-wholesale-progress" style="margin: 12px 0; padding: 10px 14px; background: linear-gradient(135deg, #FFFBEB, #FFF7ED); border: 1px solid #FDBA74; border-radius: 8px; font-family: inherit;">
  {%- if wholesale_active -%}
    <div style="display: flex; align-items: center; gap: 6px;">
      <span style="font-size: 18px;">üéâ</span>
      <div>
        <p style="font-size: 13px; font-weight: 700; color: #15803D; margin: 0;">üè∑ Atacado Ativo!</p>
        <p style="font-size: 11px; color: #166534; margin: 2px 0 0;">‚úì Voc√™ est√° economizando com pre√ßos de atacado!</p>
      </div>
      <span style="margin-left: auto; font-size: 12px; font-weight: 600; color: #15803D;">{{ total_items }}/{{ wholesale_min }} pe√ßas</span>
    </div>
    <div style="width: 100%; height: 8px; background: #BBF7D0; border-radius: 99px; overflow: hidden; margin-top: 6px;">
      <div style="width: 100%; height: 100%; background: linear-gradient(90deg, #22C55E, #16A34A); border-radius: 99px;"></div>
    </div>
    
    {%- if has_wholesale_prices and savings > 0 -%}
      <div class="cw-total-savings">
        <p class="cw-total-savings-text">üí∞ Economia total no atacado:</p>
        <p class="cw-total-savings-amount">{{ savings | money }}</p>
      </div>
    {%- endif -%}
  {%- else -%}
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
      <span style="font-size: 12px; font-weight: 600; color: #92400E;">üõí Faltam <strong style="color: #C2410C;">{{ remaining }}</strong> pe√ßa(s) para atacado!</span>
      <span style="font-size: 11px; color: #B45309;">{{ total_items }}/{{ wholesale_min }}</span>
    </div>
    <div style="width: 100%; height: 8px; background: #FDE68A; border-radius: 99px; overflow: hidden;">
      <div style="width: {{ progress }}%; height: 100%; background: linear-gradient(90deg, #F59E0B, #D97706); border-radius: 99px; transition: width 0.4s ease;"></div>
    </div>
    <p style="font-size: 10px; color: #92400E; margin: 4px 0 0; text-align: center;">Adicione mais itens e pague pre√ßo de atacado üí∞</p>
  {%- endif -%}
</div>

<script>
(function() {
  // Atualizar total do carrinho com pre√ßos de atacado
  var wholesaleActive = {{ wholesale_active | json }};
  var wholesaleTotal = {{ wholesale_total | json }};
  var hasWholesalePrices = {{ has_wholesale_prices | json }};
  
  if (wholesaleActive && hasWholesalePrices && wholesaleTotal > 0) {
    // Aguardar DOM carregar
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateCartTotal);
    } else {
      updateCartTotal();
    }
    
    function updateCartTotal() {
      // Selecionar elemento do total (ajuste o seletor conforme seu tema)
      var totalElements = document.querySelectorAll('.mini-cart__recap-price-line span:last-child, .cart__total-price');
      
      totalElements.forEach(function(el) {
        if (el && el.textContent.includes('R$')) {
          // Adicionar indicador visual de atacado
          var wholesaleBadge = document.createElement('span');
          wholesaleBadge.className = 'cw-badge-atacado';
          wholesaleBadge.style.marginLeft = '6px';
          wholesaleBadge.textContent = 'üè∑ Atacado';
          
          // Atualizar valor
          el.innerHTML = '{{ wholesaleTotal | money }}';
          el.appendChild(wholesaleBadge);
        }
      });
    }
  }
})();
</script>
