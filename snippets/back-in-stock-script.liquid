<script>
(function() {
  var productId = null;
  var variants = [];
  var button = null;
  var lastCheck = '';
  
  function checkVariant() {
    if (!button) return;
    
    var form = document.querySelector('.product-form');
    if (!form) return;
    
    var options = [];
    
    // Pegar opções selecionadas
    var radios = form.querySelectorAll('.product-form__single-selector[type="radio"]:checked');
    radios.forEach(function(r) {
      var pos = parseInt(r.getAttribute('data-option-position'));
      options[pos - 1] = r.value;
    });
    
    var selects = form.querySelectorAll('.product-form__single-selector[data-option-position]');
    selects.forEach(function(s) {
      if (s.tagName === 'SELECT') {
        var pos = parseInt(s.getAttribute('data-option-position'));
        options[pos - 1] = s.value;
      }
    });
    
    options = options.filter(function(v) { return v; });
    var checkKey = options.join('|');
    
    // Só processar se mudou
    if (checkKey === lastCheck) return;
    lastCheck = checkKey;
    
    // Encontrar variante
    for (var i = 0; i < variants.length; i++) {
      var v = variants[i];
      var match = true;
      
      if (options[0] && v.option1 !== options[0]) match = false;
      if (options[1] && v.option2 !== options[1]) match = false;
      if (options[2] && v.option3 !== options[2]) match = false;
      
      if (match) {
        var vid = document.getElementById('bisn-variant-id-' + productId);
        var vtitle = document.getElementById('bisn-variant-title-' + productId);
        var vdisplay = document.getElementById('bisn-variant-display-' + productId);
        
        if (!v.available) {
          button.style.display = 'block';
          if (vid) vid.value = v.id;
          if (vtitle) vtitle.value = v.title || '';
          if (vdisplay) vdisplay.textContent = v.title || '';
        } else {
          button.style.display = 'none';
        }
        return;
      }
    }
  }
  
  function init() {
    var form = document.querySelector('.product-form');
    if (!form) {
      setTimeout(init, 300);
      return;
    }
    
    var json = form.querySelector('[data-product-json]');
    if (!json) {
      setTimeout(init, 300);
      return;
    }
    
    try {
      var data = JSON.parse(json.textContent);
      var product = data.product || data;
      productId = product.id;
      variants = product.variants || [];
      button = document.getElementById('notify-trigger-' + productId);
      
      if (!button) {
        setTimeout(init, 300);
        return;
      }
      
      // Verificar inicial
      checkVariant();
      
      // Verificar a cada 200ms (mais rápido)
      setInterval(checkVariant, 200);
      
      // Capturar TODOS os cliques no documento
      document.addEventListener('click', function() {
        setTimeout(checkVariant, 10);
        setTimeout(checkVariant, 50);
        setTimeout(checkVariant, 150);
        setTimeout(checkVariant, 300);
      }, true);
      
      // Capturar mudanças
      document.addEventListener('change', function() {
        setTimeout(checkVariant, 10);
        setTimeout(checkVariant, 50);
        setTimeout(checkVariant, 150);
      }, true);
      
      // Observer
      var observer = new MutationObserver(function() {
        checkVariant();
      });
      
      observer.observe(form, {
        attributes: true,
        attributeFilter: ['checked', 'selected', 'class'],
        subtree: true,
        childList: true
      });
      
      // Evento do tema
      document.addEventListener('variant:changed', function(e) {
        if (e.detail && e.detail.variant) {
          var v = e.detail.variant;
          var vid = document.getElementById('bisn-variant-id-' + productId);
          var vtitle = document.getElementById('bisn-variant-title-' + productId);
          var vdisplay = document.getElementById('bisn-variant-display-' + productId);
          
          if (!v.available) {
            button.style.display = 'block';
            if (vid) vid.value = v.id;
            if (vtitle) vtitle.value = v.title || '';
            if (vdisplay) vdisplay.textContent = v.title || '';
          } else {
            button.style.display = 'none';
          }
        }
      });
      
    } catch (e) {
      setTimeout(init, 300);
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
  setTimeout(init, 100);
  setTimeout(init, 500);
  setTimeout(init, 1000);
})();
</script>
