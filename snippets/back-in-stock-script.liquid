<script>
(function() {
  var productId = null;
  var productData = null;
  
  // Função para mostrar/ocultar botão
  function toggleButton(variant) {
    if (!productId) return;
    
    var button = document.getElementById('notify-trigger-' + productId);
    if (!button) return;
    
    var variantIdInput = document.getElementById('bisn-variant-id-' + productId);
    var variantTitleInput = document.getElementById('bisn-variant-title-' + productId);
    var variantDisplay = document.getElementById('bisn-variant-display-' + productId);
    
    if (variant && !variant.available) {
      // Variante esgotada - mostrar botão
      button.style.display = 'block';
      
      if (variantIdInput) variantIdInput.value = variant.id;
      if (variantTitleInput) variantTitleInput.value = variant.title || '';
      if (variantDisplay) variantDisplay.textContent = variant.title || '';
    } else {
      // Variante disponível - esconder botão
      button.style.display = 'none';
    }
  }
  
  // Encontrar variante baseada nas opções selecionadas
  function findSelectedVariant() {
    if (!productData || !productData.variants) return null;
    
    var form = document.querySelector('.product-form');
    if (!form) return null;
    
    var selectedOptions = [];
    
    // Pegar valores dos radio buttons selecionados
    var radioInputs = form.querySelectorAll('input[type="radio"]:checked[name^="option"]');
    radioInputs.forEach(function(input) {
      selectedOptions.push(input.value);
    });
    
    // Pegar valores dos selects
    var selectInputs = form.querySelectorAll('select[name^="option"]');
    selectInputs.forEach(function(select) {
      if (select.value) {
        selectedOptions.push(select.value);
      }
    });
    
    // Se não encontrou opções, tentar método alternativo
    if (selectedOptions.length === 0) {
      var singleSelectors = form.querySelectorAll('.product-form__single-selector');
      singleSelectors.forEach(function(input) {
        if (input.checked || input.selected) {
          selectedOptions.push(input.value);
        }
      });
    }
    
    // Encontrar variante que corresponde
    if (selectedOptions.length > 0) {
      return productData.variants.find(function(variant) {
        var match = true;
        if (selectedOptions[0] && variant.option1 !== selectedOptions[0]) match = false;
        if (selectedOptions[1] && variant.option2 !== selectedOptions[1]) match = false;
        if (selectedOptions[2] && variant.option3 !== selectedOptions[2]) match = false;
        return match;
      });
    }
    
    return null;
  }
  
  // Atualizar baseado na seleção atual
  function updateButton() {
    var variant = findSelectedVariant();
    if (variant) {
      toggleButton(variant);
    }
  }
  
  // Inicializar
  function init() {
    var form = document.querySelector('.product-form');
    if (!form) return;
    
    var dataElement = form.querySelector('[data-product-json]');
    if (!dataElement) return;
    
    try {
      var data = JSON.parse(dataElement.textContent);
      productData = data.product || data;
      productId = productData.id;
      
      // Verificar estado inicial
      updateButton();
      
      // Observar mudanças em TODOS os inputs de variante
      var allInputs = form.querySelectorAll('input[name^="option"], select[name^="option"], .product-form__single-selector');
      
      allInputs.forEach(function(input) {
        input.addEventListener('change', function() {
          setTimeout(updateButton, 50);
        });
        
        input.addEventListener('click', function() {
          setTimeout(updateButton, 50);
        });
      });
      
      // Observar mudanças no DOM (para temas que atualizam dinamicamente)
      var observer = new MutationObserver(function() {
        setTimeout(updateButton, 100);
      });
      
      observer.observe(form, {
        attributes: true,
        attributeFilter: ['class', 'data-variant-id'],
        subtree: true
      });
      
    } catch (e) {
      console.error('Erro ao inicializar notificação de estoque:', e);
    }
  }
  
  // Escutar eventos customizados do tema
  document.addEventListener('variant:changed', function(event) {
    if (event.detail && event.detail.variant) {
      toggleButton(event.detail.variant);
    }
  });
  
  // Também escutar evento de mudança de variante (alguns temas usam este)
  document.addEventListener('variantChange', function(event) {
    if (event.detail && event.detail.variant) {
      toggleButton(event.detail.variant);
    }
  });
  
  // Inicializar
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
  // Re-inicializar após um pequeno delay (para garantir que o tema carregou)
  setTimeout(init, 500);
})();
</script>
