<script>
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    var form = document.querySelector('.product-form');
    if (!form) return;
    
    var productJson = form.querySelector('[data-product-json]');
    if (!productJson) return;
    
    var data = JSON.parse(productJson.textContent);
    var product = data.product || data;
    var productId = product.id;
    var variants = product.variants || [];
    var button = document.getElementById('notify-trigger-' + productId);
    
    if (!button) return;
    
    // Função para atualizar botão
    function updateButton() {
      var selectedOptions = [];
      var selectors = form.querySelectorAll('.product-form__single-selector');
      
      selectors.forEach(function(sel) {
        if (sel.type === 'radio' && sel.checked) {
          var pos = sel.getAttribute('data-option-position');
          selectedOptions[pos - 1] = sel.value;
        } else if (sel.tagName === 'SELECT') {
          var pos = sel.getAttribute('data-option-position');
          selectedOptions[pos - 1] = sel.value;
        }
      });
      
      selectedOptions = selectedOptions.filter(function(v) { return v; });
      
      // Encontrar variante
      var variant = null;
      for (var i = 0; i < variants.length; i++) {
        var v = variants[i];
        var match = true;
        if (selectedOptions[0] && v.option1 !== selectedOptions[0]) match = false;
        if (selectedOptions[1] && v.option2 !== selectedOptions[1]) match = false;
        if (selectedOptions[2] && v.option3 !== selectedOptions[2]) match = false;
        if (match) {
          variant = v;
          break;
        }
      }
      
      if (variant) {
        var vid = document.getElementById('bisn-variant-id-' + productId);
        var vtitle = document.getElementById('bisn-variant-title-' + productId);
        var vdisplay = document.getElementById('bisn-variant-display-' + productId);
        
        if (!variant.available) {
          button.style.display = 'block';
          if (vid) vid.value = variant.id;
          if (vtitle) vtitle.value = variant.title || '';
          if (vdisplay) vdisplay.textContent = variant.title || '';
        } else {
          button.style.display = 'none';
        }
      }
    }
    
    // Adicionar listeners
    var selectors = form.querySelectorAll('.product-form__single-selector');
    selectors.forEach(function(sel) {
      sel.addEventListener('change', function() {
        setTimeout(updateButton, 100);
      });
      if (sel.type === 'radio') {
        sel.addEventListener('click', function() {
          setTimeout(updateButton, 100);
        });
      }
    });
    
    // Evento do tema
    document.addEventListener('variant:changed', function(e) {
      if (e.detail && e.detail.variant) {
        var v = e.detail.variant;
        var vid = document.getElementById('bisn-variant-id-' + productId);
        var vtitle = document.getElementById('bisn-variant-title-' + productId);
        var vdisplay = document.getElementById('bisn-variant-display-' + productId);
        
        if (!v.available) {
          button.style.display = 'block';
          if (vid) vid.value = v.id;
          if (vtitle) vtitle.value = v.title || '';
          if (vdisplay) vdisplay.textContent = v.title || '';
        } else {
          button.style.display = 'none';
        }
      }
    });
    
    // Verificar inicial
    updateButton();
    
  }, 1000);
});
</script>
