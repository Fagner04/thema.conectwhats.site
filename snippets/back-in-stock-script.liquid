<script>
(function() {
  // Função para mostrar/ocultar botão de notificação e atualizar dados
  function toggleBackInStockButton(productId, variant, isAvailable) {
    const button = document.getElementById('notify-trigger-' + productId);
    const variantIdInput = document.getElementById('bisn-variant-id-' + productId);
    const variantTitleInput = document.getElementById('bisn-variant-title-' + productId);
    const variantDisplay = document.getElementById('bisn-variant-display-' + productId);
    
    if (button) {
      if (!isAvailable && variant) {
        button.style.display = 'block';
        
        if (variantIdInput) {
          variantIdInput.value = variant.id;
        }
        
        if (variantTitleInput && variantDisplay) {
          const variantTitle = variant.title || variant.name || '';
          variantTitleInput.value = variantTitle;
          variantDisplay.textContent = variantTitle;
        }
      } else {
        button.style.display = 'none';
      }
    }
  }
  
  // Preencher dados iniciais
  function initializeBackInStock() {
    const productForms = document.querySelectorAll('.product-form');
    
    productForms.forEach(function(form) {
      const productData = form.querySelector('[data-product-json]');
      if (productData) {
        try {
          const data = JSON.parse(productData.textContent);
          const selectedVariant = data.product.variants.find(v => v.id === data.selected_variant_id);
          if (selectedVariant) {
            // Preencher dados iniciais mesmo se estiver disponível
            const variantIdInput = document.getElementById('bisn-variant-id-' + data.product.id);
            const variantTitleInput = document.getElementById('bisn-variant-title-' + data.product.id);
            const variantDisplay = document.getElementById('bisn-variant-display-' + data.product.id);
            
            if (variantIdInput) variantIdInput.value = selectedVariant.id;
            if (variantTitleInput) variantTitleInput.value = selectedVariant.title;
            if (variantDisplay) variantDisplay.textContent = selectedVariant.title;
            
            // Controlar visibilidade
            toggleBackInStockButton(data.product.id, selectedVariant, selectedVariant.available);
          }
        } catch (e) {
          console.error('Erro ao processar dados do produto:', e);
        }
      }
    });
  }
  
  // Escutar mudanças de variante
  document.addEventListener('variant:changed', function(event) {
    const variant = event.detail.variant;
    if (variant) {
      const productForm = event.target.closest('.product-form');
      if (productForm) {
        const productData = productForm.querySelector('[data-product-json]');
        if (productData) {
          try {
            const data = JSON.parse(productData.textContent);
            toggleBackInStockButton(data.product.id, variant, variant.available);
          } catch (e) {
            console.error('Erro ao processar dados do produto:', e);
          }
        }
      }
    }
  });
  
  // Inicializar quando DOM estiver pronto
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeBackInStock);
  } else {
    initializeBackInStock();
  }
})();
</script>
