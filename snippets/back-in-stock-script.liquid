<script>
(function() {
  // Função para mostrar/ocultar botão de notificação e atualizar dados
  function toggleBackInStockButton(productId, variant, isAvailable) {
    const button = document.getElementById('notify-trigger-' + productId);
    const variantIdInput = document.getElementById('notify-variant-id-' + productId);
    const variantTitleInput = document.getElementById('notify-variant-title-' + productId);
    const variantDisplay = document.getElementById('notify-variant-display-' + productId);
    
    if (button) {
      if (!isAvailable && variant) {
        button.style.display = 'block';
        
        if (variantIdInput) {
          variantIdInput.value = variant.id;
        }
        
        if (variantTitleInput && variantDisplay) {
          const variantTitle = variant.title || variant.name || '';
          variantTitleInput.value = variantTitle;
          variantDisplay.textContent = variantTitle;
        }
      } else {
        button.style.display = 'none';
      }
    }
  }
  
  // Escutar mudanças de variante
  document.addEventListener('variant:changed', function(event) {
    const variant = event.detail.variant;
    if (variant) {
      const productForm = event.target.closest('.product-form');
      if (productForm) {
        const productData = productForm.querySelector('[data-product-json]');
        if (productData) {
          try {
            const data = JSON.parse(productData.textContent);
            toggleBackInStockButton(data.product.id, variant, variant.available);
          } catch (e) {
            console.error('Erro ao processar dados do produto:', e);
          }
        }
      }
    }
  });
  
  // Verificar estado inicial ao carregar a página
  document.addEventListener('DOMContentLoaded', function() {
    const productForms = document.querySelectorAll('.product-form');
    productForms.forEach(function(form) {
      const productData = form.querySelector('[data-product-json]');
      if (productData) {
        try {
          const data = JSON.parse(productData.textContent);
          const selectedVariant = data.product.variants.find(v => v.id === data.selected_variant_id);
          if (selectedVariant) {
            toggleBackInStockButton(data.product.id, selectedVariant, selectedVariant.available);
          }
        } catch (e) {
          console.error('Erro ao processar dados do produto:', e);
        }
      }
    });
  });
})();
</script>
