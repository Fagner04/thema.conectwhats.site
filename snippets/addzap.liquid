{%- comment -%}
  WhatsApp Chat Widget Moderno
  Com op√ß√µes de rastreio e c√°lculo de frete
{%- endcomment -%}

<style>
:root {
  --whatsapp-primary: {{ settings.colorzap | default: '#7c3aed' }};
  --whatsapp-bg: #f5f5f5;
  --whatsapp-text: #4a5568;
}

<<<<<<< HEAD
.sticky-button {
    position: fixed;
    background: none var(--imagezap-background);
    background-size: contain;
    background-repeat: no-repeat;
    bottom: 20px;
    right: 20px;
    border-radius: 50px;
    box-shadow: 0 0px 12px 0 rgb(0 0 0 / 10%);
    z-index: 20;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 55px;
    height: 55px;
    -webkit-transition: all .3s ease-in-out;
    transition: all .3s ease-in-out;
}

.sticky-button:hover {
    opacity: .7;
    transform: scale(.95);
}

.sticky-button svg {
	margin: auto;
	fill: #fff;
    width: 35px;
	height: 35px;
}

.sticky-button a,.sticky-button label {
	cursor: pointer;
	display: flex;
	align-items: center;
	width: 55px;
	height: 55px;
	-webkit-transition: all .3s ease-out;
	transition: all .3s ease-out;
}

.sticky-button label svg.close-icon {
	display: none;
}

.sticky-chat {
	position: fixed;
	bottom: 85px;
	right: 20px;
	width: 320px;
	-webkit-transition: all .3s ease-out;
	transition: all .3s ease-out;
	z-index: 21;
	opacity: 0;
	visibility: hidden;
}

.sticky-chat a {
  text-decoration: none;
  font-family: 'Roboto',sans-serif;
  color: #505050;
  
}

.sticky-chat svg {
	width: 35px;
	height: 35px;
}

.sticky-chat .chat-content {
	border-radius: 14px;
    background-color: #dbe0e6b8;
    backdrop-filter: blur(25px);
	overflow: hidden;
	font-family: var(--text-font-family);
	font-weight: 400;
}

.sticky-chat .chat-header {
	position: relative;
	display: flex;
	align-items: center;
	padding: 15px 20px;
	background-color: var(--colorzap-color);
	overflow: hidden;
}

.sticky-chat .chat-header:after {
	content: '';
	display: block;
	position: absolute;
	bottom: 0;
	right: 0;
	width: 80px;
	height: 75px;
	background: rgba(0,0,0,.040);
	border-radius: 70px 0 5px 0;
}

.sticky-chat .chat-header svg {
	width: 35px;
	height: 35px;
	flex: 0 0 auto;
	fill: #fff;
}

.sticky-chat .chat-header .title {
	padding-left: 12px;
	font-size: 14px;
	font-weight: 600;
	font-family: var(--heading-font-family);
  color: #fff;
}

.sticky-chat .chat-header .title span {
	font-size: 11px;
	font-weight: 400;
	display: block;
	line-height: 1.58em;
	margin: 0;
	color: #f4f4f4;
}

.sticky-chat .chat-text {
	display: flex;
	flex-wrap: wrap;
	margin: 30px 20px;
	font-size: 12px;
}

.sticky-chat .chat-text span {
	display: inline-block;
	margin-right: auto;
	padding: 10px;
    height: fit-content;
	background-color: white;
	border-radius: 0px 15px 15px;
    box-shadow: 0 10px 20px #151b230f;
}

.sticky-chat .chat-text span:after {
	content: 'agora mesmo';
	display: inline-block;
	margin-left: 10px;
	font-size: 9px;
	color: #989b9f;
}

.sticky-chat .chat-text span.typing {
	margin: 15px 0 0 auto;
	padding: 4px;
	border-radius: 15px 0px 15px 15px;
}

.sticky-chat .chat-text span.typing:after {
	display: none;
}

.sticky-chat .chat-text span.typing svg {
	height: 13px;
	fill: #505050;
}

.sticky-chat .chat-button {
  
	display: block;
	align-items: center;
	margin-top: 5px;
	padding: 10px;
	border-radius: 14px;
    background-color: #dbe0e6b8;
    backdrop-filter: blur(25px);
	overflow: hidden;
	font-size: 12px;
	font-family: var(--text-font-family);
	font-weight: 400;
  
}

.sticky-chat .chat-button svg {
	width: 20px;
	height: 20px;
	fill: #505050;
	margin-left: auto;
	transform: rotate(40deg);
	-webkit-transform: rotate(40deg);
}

.chat-menu:checked+.sticky-button label {
	-webkit-transform: rotate(360deg);
	transform: rotate(360deg);
}

.chat-menu:checked+.sticky-button label svg.chat-icon {
	display: none;
}

.chat-menu:checked+.sticky-button label svg.close-icon {
	display: table-cell;
}

.chat-menu:checked+.sticky-button+.sticky-chat {
   bottom: 88px;
   right: 18px;
   opacity: 1;
   visibility: visible;
}

.wa-chat-widget-send form {
   display: flex;
   margin: 0;
   box-shadow: 0 10px 20px #151b230f;        
}

.wa-chat-widget-send input {
   background: white;
   border: 0;
   border-right: 1px solid #dee6ef;
   color: #c1c5ca;
   padding: 0.5rem 1.2rem;
   width: 100%;
   border-radius: 10px 0 0 10px;
}

.wa-chat-widget-send button {
   background-color: white;
   padding: 0.5rem;
   padding-top: 11px;
   padding-right: 15px;
   border-radius: 0 10px 10px 0;
   border: none;
   fill: #ffffff;
}

@keyframes wa-chat-animation {
  from {
    opacity: 0;
  }
}
    
@media (max-width: 768px) {
  .sticky-button {
    bottom: 64px;
  }

  .chat-menu:checked+.sticky-button+.sticky-chat { 
    bottom: 125px;
    right: 21px;
  }
}

/* Tamanho menor para desktop */
@media (min-width: 769px) {
  .sticky-button {
    width: 45px;
    height: 45px;
  }
  
  .sticky-button a,
  .sticky-button label {
    width: 45px;
    height: 45px;
  }
  
  .sticky-button svg,
  .sticky-button img {
    width: 28px !important;
    height: 28px !important;
  }
  
  .online-icon {
    bottom: 18px;
    right: 18px;
  }
  
  .online-icon::after {
    width: 12px;
    height: 12px;
  }
}

.form-zap {
  display: flex;
  flex-direction: row;
}

.online-icon {
=======
.whatsapp-widget {
>>>>>>> 5cf243451390bd75a19e88c96ed26b42987378c6
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* Bal√£o de mensagem externa */
.whatsapp-external-message {
  position: absolute;
  bottom: 0;
  right: 80px;
  background: white;
  border-radius: 20px;
  padding: 12px 16px;
  max-width: 320px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  opacity: 0;
  visibility: hidden;
  transform: translateX(20px);
  transition: all 0.4s ease-out;
  z-index: 9998;
  white-space: nowrap;
}

.whatsapp-external-message.show {
  opacity: 1;
  visibility: visible;
  transform: translateX(0);
}

.whatsapp-external-message::after {
  content: '';
  position: absolute;
  right: -8px;
  bottom: 18px;
  width: 0;
  height: 0;
  border-left: 10px solid white;
  border-top: 8px solid transparent;
  border-bottom: 8px solid transparent;
}

.whatsapp-external-message-text {
  font-size: 14px;
  color: #374151;
  line-height: 1.4;
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  display: inline;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 280px;
}

.whatsapp-external-message-time {
  font-size: 11px;
  color: #9ca3af;
  margin-left: 8px;
  display: inline;
  white-space: nowrap;
}

.whatsapp-external-close {
  position: absolute;
  top: 6px;
  right: 6px;
  background: none;
  border: none;
  color: #9ca3af;
  cursor: pointer;
  font-size: 16px;
  line-height: 1;
  padding: 2px 6px;
  transition: color 0.2s;
}

.whatsapp-external-close:hover {
  color: #374151;
}

/* Indicador de digita√ß√£o externo */
.whatsapp-external-typing {
  position: absolute;
  bottom: 0;
  right: 80px;
  background: white;
  border-radius: 16px;
  padding: 12px 18px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  opacity: 0;
  visibility: hidden;
  transform: translateX(20px);
  transition: all 0.4s ease-out;
  z-index: 9998;
  display: none;
}

.whatsapp-external-typing.show {
  opacity: 1;
  visibility: visible;
  transform: translateX(0);
  display: block;
}

.whatsapp-external-typing::after {
  content: '';
  position: absolute;
  right: -8px;
  bottom: 15px;
  width: 0;
  height: 0;
  border-left: 10px solid white;
  border-top: 8px solid transparent;
  border-bottom: 8px solid transparent;
}

.whatsapp-external-typing-dots {
  display: flex;
  gap: 4px;
  align-items: center;
}

.whatsapp-external-typing-dots span {
  width: 8px;
  height: 8px;
  background: #9ca3af;
  border-radius: 50%;
  animation: typing 1.4s infinite;
}

.whatsapp-external-typing-dots span:nth-child(2) {
  animation-delay: 0.2s;
}

.whatsapp-external-typing-dots span:nth-child(3) {
  animation-delay: 0.4s;
}

/* Mobile */
@media (max-width: 640px) {
  .whatsapp-external-message,
  .whatsapp-external-typing {
    right: 75px;
    max-width: calc(100vw - 110px);
  }
}

/* Modais de Rastreio e Frete */
.whatsapp-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 99999;
  display: none;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s;
}

.whatsapp-modal-overlay.active {
  display: flex;
}

.whatsapp-modal {
  background: white;
  border-radius: 20px;
  width: 90%;
  max-width: 500px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  animation: slideUp 0.3s;
}

.whatsapp-modal-header {
  background: var(--whatsapp-primary);
  color: white;
  padding: 20px;
  border-radius: 20px 20px 0 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.whatsapp-modal-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.whatsapp-modal-close {
  background: none;
  border: none;
  color: white;
  font-size: 28px;
  cursor: pointer;
  line-height: 1;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.whatsapp-modal-body {
  padding: 25px;
}

.whatsapp-modal-form {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.whatsapp-modal-input-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.whatsapp-modal-label {
  font-size: 14px;
  font-weight: 600;
  color: #374151;
}

.whatsapp-modal-input {
  padding: 12px 16px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  font-size: 16px;
  outline: none;
  transition: border-color 0.2s;
}

.whatsapp-modal-input:focus {
  border-color: var(--whatsapp-primary);
}

.whatsapp-modal-button {
  background: var(--whatsapp-primary);
  color: white;
  border: none;
  padding: 14px;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 10px;
}

.whatsapp-modal-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
}

.whatsapp-modal-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.whatsapp-modal-result {
  margin-top: 20px;
  padding: 15px;
  background: #f3f4f6;
  border-radius: 12px;
  display: none;
}

.whatsapp-modal-result.show {
  display: block;
}

.whatsapp-modal-result h4 {
  margin: 0 0 12px 0;
  font-size: 16px;
  color: #374151;
}

.whatsapp-shipping-option {
  background: white;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.whatsapp-shipping-option:last-child {
  margin-bottom: 0;
}

.whatsapp-shipping-name {
  font-weight: 600;
  color: #374151;
  font-size: 14px;
}

.whatsapp-shipping-time {
  font-size: 12px;
  color: #9ca3af;
  margin-top: 4px;
}

.whatsapp-shipping-price {
  font-size: 16px;
  font-weight: 700;
  color: var(--whatsapp-primary);
}

.whatsapp-tracking-status {
  background: white;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 10px;
}

.whatsapp-tracking-date {
  font-size: 12px;
  color: #9ca3af;
  margin-bottom: 4px;
}

.whatsapp-tracking-text {
  font-size: 14px;
  color: #374151;
  line-height: 1.5;
}

.whatsapp-modal-error {
  background: #fee2e2;
  color: #991b1b;
  padding: 12px;
  border-radius: 8px;
  font-size: 14px;
  margin-top: 15px;
  display: none;
}

.whatsapp-modal-error.show {
  display: block;
}

.whatsapp-modal-loading {
  text-align: center;
  padding: 20px;
  display: none;
}

.whatsapp-modal-loading.show {
  display: block;
}

.whatsapp-modal-loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #e5e7eb;
  border-top-color: var(--whatsapp-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 10px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

/* Bot√£o Flutuante */
.whatsapp-float-btn {
  width: 60px;
  height: 60px;
  background: var(--whatsapp-primary);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  transition: all 0.3s;
  position: relative;
}

.whatsapp-float-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 25px rgba(0,0,0,0.3);
}

.whatsapp-float-btn svg {
  width: 32px;
  height: 32px;
  fill: white;
}

.whatsapp-float-btn.active {
  background: #ef4444;
}

/* Indicador Online */
.whatsapp-online-indicator {
  position: absolute;
  bottom: 2px;
  right: 2px;
  width: 16px;
  height: 16px;
  background: #10b981;
  border: 3px solid white;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Chat Box */
.whatsapp-chat-box {
  position: absolute;
  bottom: 80px;
  right: 0;
  width: 360px;
  max-height: 550px;
  background: white;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  opacity: 0;
  visibility: hidden;
  transform: translateY(20px);
  transition: all 0.3s;
}

.whatsapp-chat-box.active {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

/* Header */
.whatsapp-header {
  background: var(--whatsapp-primary);
  padding: 20px;
  border-radius: 20px 20px 0 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  color: white;
}

.whatsapp-header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.whatsapp-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.whatsapp-avatar svg {
  width: 28px;
  height: 28px;
  fill: var(--whatsapp-primary);
}

.whatsapp-avatar-online {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 14px;
  height: 14px;
  background: #10b981;
  border: 2px solid var(--whatsapp-primary);
  border-radius: 50%;
}

.whatsapp-header-info h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.whatsapp-header-info p {
  margin: 2px 0 0 0;
  font-size: 12px;
  opacity: 0.9;
}

.whatsapp-close-btn {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  padding: 5px;
  font-size: 24px;
  line-height: 1;
  opacity: 0.9;
  transition: opacity 0.2s;
}

.whatsapp-close-btn:hover {
  opacity: 1;
}

/* Body */
.whatsapp-body {
  padding: 20px;
  max-height: 350px;
  overflow-y: auto;
}

/* Mensagem de Boas-vindas */
.whatsapp-welcome-message {
  background: #f3f4f6;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 20px;
  position: relative;
  padding-top: 20px;
}

.whatsapp-welcome-message::before {
  content: 'üëã';
  font-size: 20px;
  position: absolute;
  top: 12px;
  left: 15px;
}

.whatsapp-welcome-message p {
  margin: 0;
  font-size: 14px;
  color: var(--whatsapp-text);
  line-height: 1.5;
  padding-left: 30px;
}

.whatsapp-welcome-time {
  display: block;
  font-size: 11px;
  color: #9ca3af;
  margin-top: 8px;
  text-align: right;
}

/* Bot√µes de A√ß√£o */
.whatsapp-action-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 20px;
}

.whatsapp-action-btn {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
  color: var(--whatsapp-text);
}

.whatsapp-action-btn:hover {
  border-color: var(--whatsapp-primary);
  background: #faf5ff;
  transform: translateY(-2px);
}

.whatsapp-action-btn-icon {
  width: 40px;
  height: 40px;
  background: #f3f4f6;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 8px;
}

.whatsapp-action-btn-icon svg {
  width: 20px;
  height: 20px;
  fill: var(--whatsapp-primary);
}

.whatsapp-action-btn-title {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 4px;
}

.whatsapp-action-btn-subtitle {
  font-size: 11px;
  color: #9ca3af;
}

/* Input de Mensagem */
.whatsapp-input-wrapper {
  padding: 15px 20px 20px;
  border-top: 1px solid #e5e7eb;
}

.whatsapp-input-form {
  display: flex;
  gap: 10px;
}

.whatsapp-input {
  flex: 1;
  padding: 12px 16px;
  border: 1px solid #e5e7eb;
  border-radius: 25px;
  font-size: 16px;
  outline: none;
  transition: border-color 0.2s;
}

.whatsapp-input:focus {
  border-color: var(--whatsapp-primary);
}

.whatsapp-send-btn {
  width: 45px;
  height: 45px;
  background: var(--whatsapp-primary);
  border: none;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.whatsapp-send-btn:hover {
  transform: scale(1.05);
}

.whatsapp-send-btn svg {
  width: 20px;
  height: 20px;
  fill: white;
}

/* Footer */
.whatsapp-footer {
  padding: 12px 20px;
  text-align: center;
  font-size: 11px;
  color: #9ca3af;
  border-top: 1px solid #e5e7eb;
}

/* Mobile */
@media (max-width: 640px) {
  .whatsapp-widget {
    bottom: 15px;
    right: 15px;
  }
  
  .whatsapp-chat-box {
    width: calc(100vw - 30px);
    max-width: 360px;
  }
  
  .whatsapp-float-btn {
    width: 55px;
    height: 55px;
  }
  
  .whatsapp-float-btn svg {
    width: 28px;
    height: 28px;
  }
}

/* Indicador de digita√ß√£o */
.whatsapp-typing-indicator {
  display: none;
  background: white;
  padding: 12px 16px;
  border-radius: 12px;
  margin-bottom: 12px;
  width: fit-content;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.whatsapp-typing-dots {
  display: flex;
  gap: 4px;
  align-items: center;
}

.whatsapp-typing-dots span {
  width: 8px;
  height: 8px;
  background: #9ca3af;
  border-radius: 50%;
  animation: typing 1.4s infinite;
}

.whatsapp-typing-dots span:nth-child(2) {
  animation-delay: 0.2s;
}

.whatsapp-typing-dots span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% {
    transform: translateY(0);
    opacity: 0.7;
  }
  30% {
    transform: translateY(-10px);
    opacity: 1;
  }
}

/* Mensagens autom√°ticas */
.whatsapp-auto-message {
  background: white;
  padding: 12px 16px;
  border-radius: 12px;
  margin-bottom: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  animation: messageSlideIn 0.3s ease-out;
  display: none;
}

.whatsapp-auto-message p {
  margin: 0;
  font-size: 14px;
  color: var(--whatsapp-text);
  line-height: 1.5;
}

.whatsapp-auto-message-time {
  display: block;
  font-size: 11px;
  color: #9ca3af;
  margin-top: 6px;
  text-align: right;
}

@keyframes messageSlideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.whatsapp-body::-webkit-scrollbar {
  width: 6px;
}

.whatsapp-body::-webkit-scrollbar-track {
  background: #f3f4f6;
}

.whatsapp-body::-webkit-scrollbar-thumb {
  background: #d1d5db;
  border-radius: 3px;
}

.whatsapp-body::-webkit-scrollbar-thumb:hover {
  background: #9ca3af;
}
</style>

<div class="whatsapp-widget">
  <!-- Indicador de digita√ß√£o externo -->
  <div class="whatsapp-external-typing" id="whatsapp-external-typing">
    <div class="whatsapp-external-typing-dots">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>

  <!-- Bal√£o de mensagem externo -->
  <div class="whatsapp-external-message" id="whatsapp-external-message">
    <button class="whatsapp-external-close" id="whatsapp-external-close">√ó</button>
    <span class="whatsapp-external-message-text" id="whatsapp-external-text"></span>
    <span class="whatsapp-external-message-time" id="whatsapp-external-time"></span>
  </div>

  <!-- Bot√£o Flutuante -->
  <div class="whatsapp-float-btn" id="whatsapp-toggle">
    {% if settings.show_online_icon %}
      <div class="whatsapp-online-indicator"></div>
    {% endif %}
    
    <svg class="whatsapp-icon" viewBox="0 0 24 24">
      <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
    </svg>
    
    <svg class="whatsapp-close-icon" viewBox="0 0 24 24" style="display: none;">
      <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
    </svg>
  </div>

  <!-- Chat Box -->
  <div class="whatsapp-chat-box" id="whatsapp-chat">
    <!-- Header -->
    <div class="whatsapp-header">
      <div class="whatsapp-header-left">
        <div class="whatsapp-avatar">
          {% if settings.zap_img_type == 'img' and settings.zap_img %}
            <img src="{{ settings.zap_img | img_url: '100x' }}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
          {% else %}
            <svg viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
            </svg>
          {% endif %}
          {% if settings.show_online_icon %}
            <div class="whatsapp-avatar-online"></div>
          {% endif %}
        </div>
        <div class="whatsapp-header-info">
          <h3>{{ settings.titlezap | default: 'Atendimento' }}</h3>
          <p id="whatsapp-status">‚óè Online</p>
        </div>
      </div>
      <button class="whatsapp-close-btn" id="whatsapp-close">√ó</button>
    </div>

    <!-- Body -->
    <div class="whatsapp-body">
      <!-- Mensagem de Boas-vindas -->
      <div class="whatsapp-welcome-message">
        <p id="whatsapp-greeting">{{ settings.chatzap | default: 'Ol√°! Bem-vindo. Como posso ajudar voc√™ hoje?' }}</p>
        <span class="whatsapp-welcome-time" id="whatsapp-time-greeting">Boa noite! üëç</span>
      </div>

      <!-- Indicador de digita√ß√£o -->
      <div class="whatsapp-typing-indicator" id="whatsapp-typing">
        <div class="whatsapp-typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>

      <!-- Container para mensagens autom√°ticas -->
      <div id="whatsapp-auto-messages"></div>

      <!-- Bot√µes de A√ß√£o -->
      <div class="whatsapp-action-buttons">
        {% if settings.whatsapp_show_tracking %}
        <a href="#" class="whatsapp-action-btn" id="whatsapp-tracking-btn">
          <div class="whatsapp-action-btn-icon">
            <svg viewBox="0 0 24 24">
              <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
            </svg>
          </div>
          <div class="whatsapp-action-btn-title">Rastrear</div>
          <div class="whatsapp-action-btn-subtitle">Meu pedido</div>
        </a>
        {% endif %}
        
        {% if settings.whatsapp_show_shipping %}
        <a href="#" class="whatsapp-action-btn" id="whatsapp-shipping-btn">
          <div class="whatsapp-action-btn-icon">
            <svg viewBox="0 0 24 24">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
            </svg>
          </div>
          <div class="whatsapp-action-btn-title">Calcular</div>
          <div class="whatsapp-action-btn-subtitle">Frete</div>
        </a>
        {% endif %}
      </div>
    </div>

    <!-- Input -->
    <div class="whatsapp-input-wrapper">
      <form class="whatsapp-input-form" id="whatsapp-form">
        <input 
          type="text" 
          class="whatsapp-input" 
          id="whatsapp-message"
          placeholder="{{ settings.digizap | default: 'Digite sua mensagem...' }}"
        >
        <button type="submit" class="whatsapp-send-btn">
          <svg viewBox="0 0 24 24">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </form>
    </div>

    <!-- Footer -->
    <div class="whatsapp-footer" id="whatsapp-footer">
      Resposta em at√© 2 horas durante hor√°rio comercial
    </div>
  </div>

  <!-- Modal de Rastreio -->
  <div class="whatsapp-modal-overlay" id="whatsapp-tracking-modal">
    <div class="whatsapp-modal">
      <div class="whatsapp-modal-header">
        <h3>Rastrear Pedido</h3>
        <button class="whatsapp-modal-close" data-modal="tracking">√ó</button>
      </div>
      <div class="whatsapp-modal-body">
        <form class="whatsapp-modal-form" id="tracking-form">
          <div class="whatsapp-modal-input-group">
            <label class="whatsapp-modal-label">C√≥digo de Rastreio</label>
            <input 
              type="text" 
              class="whatsapp-modal-input" 
              id="tracking-code"
              placeholder="Ex: AA123456789BR"
              maxlength="13"
              required
            >
          </div>
          <button type="submit" class="whatsapp-modal-button">Rastrear</button>
        </form>
        
        <div class="whatsapp-modal-loading" id="tracking-loading">
          <div class="whatsapp-modal-loading-spinner"></div>
          <p>Buscando informa√ß√µes...</p>
        </div>
        
        <div class="whatsapp-modal-result" id="tracking-result"></div>
        <div class="whatsapp-modal-error" id="tracking-error"></div>
      </div>
    </div>
  </div>

  <!-- Modal de C√°lculo de Frete -->
  <div class="whatsapp-modal-overlay" id="whatsapp-shipping-modal">
    <div class="whatsapp-modal">
      <div class="whatsapp-modal-header">
        <h3>Calcular Frete</h3>
        <button class="whatsapp-modal-close" data-modal="shipping">√ó</button>
      </div>
      <div class="whatsapp-modal-body">
        <form class="whatsapp-modal-form" id="shipping-form">
          <div class="whatsapp-modal-input-group">
            <label class="whatsapp-modal-label">CEP de Destino</label>
            <input 
              type="text" 
              class="whatsapp-modal-input" 
              id="shipping-cep"
              placeholder="00000-000"
              maxlength="9"
              required
            >
          </div>
          <button type="submit" class="whatsapp-modal-button">Calcular</button>
        </form>
        
        <div class="whatsapp-modal-loading" id="shipping-loading">
          <div class="whatsapp-modal-loading-spinner"></div>
          <p>Calculando frete...</p>
        </div>
        
        <div class="whatsapp-modal-result" id="shipping-result"></div>
        <div class="whatsapp-modal-error" id="shipping-error"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  var toggle = document.getElementById('whatsapp-toggle');
  var chatBox = document.getElementById('whatsapp-chat');
  var closeBtn = document.getElementById('whatsapp-close');
  var form = document.getElementById('whatsapp-form');
  var messageInput = document.getElementById('whatsapp-message');
  var whatsappIcon = toggle.querySelector('.whatsapp-icon');
  var closeIcon = toggle.querySelector('.whatsapp-close-icon');
  var statusElement = document.getElementById('whatsapp-status');
  var greetingElement = document.getElementById('whatsapp-greeting');
  var timeGreetingElement = document.getElementById('whatsapp-time-greeting');
  var footerElement = document.getElementById('whatsapp-footer');
  var onlineIndicator = toggle.querySelector('.whatsapp-online-indicator');
  var avatarOnline = chatBox.querySelector('.whatsapp-avatar-online');
  
  var whatsappNumber = '{{ settings.numberzap }}';
  
  // Mensagens autom√°ticas configuradas
  var autoMessages = [];
  {% if settings.whatsapp_auto_message_1 != blank %}
    autoMessages.push('{{ settings.whatsapp_auto_message_1 | escape }}');
  {% endif %}
  {% if settings.whatsapp_auto_message_2 != blank %}
    autoMessages.push('{{ settings.whatsapp_auto_message_2 | escape }}');
  {% endif %}
  {% if settings.whatsapp_auto_message_3 != blank %}
    autoMessages.push('{{ settings.whatsapp_auto_message_3 | escape }}');
  {% endif %}
  {% if settings.whatsapp_auto_message_4 != blank %}
    autoMessages.push('{{ settings.whatsapp_auto_message_4 | escape }}');
  {% endif %}
  {% if settings.whatsapp_auto_message_5 != blank %}
    autoMessages.push('{{ settings.whatsapp_auto_message_5 | escape }}');
  {% endif %}
  
  // Configura√ß√µes de mensagens autom√°ticas
  var autoMessageConfig = {
    enabled: {{ settings.whatsapp_auto_messages_enabled | default: false | json }},
    interval: {{ settings.whatsapp_auto_message_interval | default: 5 | json }} * 1000, // segundos para ms
    pauseAfterCycle: {{ settings.whatsapp_auto_message_pause | default: 20 | json }} * 60 * 1000, // minutos para ms
    typingDuration: 2000 // 2 segundos de digita√ß√£o
  };
  
  var currentMessageIndex = 0;
  var cycleTimeout = null;
  var messageTimeout = null;
  var hasShownCycle = false;
  
  // Recupera estado do ciclo do localStorage
  var cycleState = localStorage.getItem('whatsapp_cycle_state');
  if (cycleState) {
    try {
      var state = JSON.parse(cycleState);
      var timeSinceLastMessage = Date.now() - state.timestamp;
      
      // Se completou o ciclo, verifica se ainda est√° na pausa
      if (state.completed) {
        if (timeSinceLastMessage < autoMessageConfig.pauseAfterCycle) {
          // Ainda em pausa, n√£o faz nada agora
          hasShownCycle = true;
          currentMessageIndex = 0;
        } else {
          // Pausa terminou, reinicia
          localStorage.removeItem('whatsapp_cycle_state');
          hasShownCycle = false;
          currentMessageIndex = 0;
        }
      } else {
        // Ciclo n√£o completou, continua de onde parou
        // Avan√ßa para pr√≥xima mensagem (pois a atual j√° foi mostrada)
        currentMessageIndex = state.index + 1;
        hasShownCycle = false;
      }
    } catch (e) {
      localStorage.removeItem('whatsapp_cycle_state');
    }
  }
  
  // Configura√ß√µes de hor√°rio
  var config = {
    enabled: {{ settings.whatsapp_schedule_enabled | default: false | json }},
    timezone: {{ settings.whatsapp_timezone | default: -3 | json }}, // UTC offset
    weekdayStart: '{{ settings.whatsapp_weekday_start | default: "09:00" }}',
    weekdayEnd: '{{ settings.whatsapp_weekday_end | default: "18:00" }}',
    saturdayStart: '{{ settings.whatsapp_saturday_start | default: "09:00" }}',
    saturdayEnd: '{{ settings.whatsapp_saturday_end | default: "13:00" }}',
    sundayEnabled: {{ settings.whatsapp_sunday_enabled | default: false | json }},
    sundayStart: '{{ settings.whatsapp_sunday_start | default: "09:00" }}',
    sundayEnd: '{{ settings.whatsapp_sunday_end | default: "13:00" }}',
    offlineMessage: '{{ settings.whatsapp_offline_message | default: "No momento estamos offline. Deixe sua mensagem!" }}'
  };
  
  // Fun√ß√£o para obter hor√°rio atual
  function getCurrentTime() {
    var now = new Date();
    var utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    var localTime = new Date(utc + (3600000 * config.timezone));
    return localTime;
  }
  
  // Fun√ß√£o para verificar se est√° no hor√°rio de atendimento
  function isOnline() {
    if (!config.enabled) return true; // Se n√£o configurado, sempre online
    
    var now = getCurrentTime();
    var day = now.getDay(); // 0 = Domingo, 6 = S√°bado
    var currentTime = now.getHours() * 60 + now.getMinutes();
    
    var start, end;
    
    // Domingo
    if (day === 0) {
      if (!config.sundayEnabled) return false;
      start = timeToMinutes(config.sundayStart);
      end = timeToMinutes(config.sundayEnd);
    }
    // S√°bado
    else if (day === 6) {
      start = timeToMinutes(config.saturdayStart);
      end = timeToMinutes(config.saturdayEnd);
    }
    // Segunda a Sexta
    else {
      start = timeToMinutes(config.weekdayStart);
      end = timeToMinutes(config.weekdayEnd);
    }
    
    return currentTime >= start && currentTime <= end;
  }
  
  // Converte hora (HH:MM) para minutos
  function timeToMinutes(time) {
    var parts = time.split(':');
    return parseInt(parts[0]) * 60 + parseInt(parts[1]);
  }
  
  // Fun√ß√£o para obter sauda√ß√£o baseada no hor√°rio
  function getGreeting() {
    var now = getCurrentTime();
    var hour = now.getHours();
    
    if (hour >= 6 && hour < 12) {
      return { text: 'Bom dia!', emoji: '‚òÄÔ∏è' };
    } else if (hour >= 12 && hour < 18) {
      return { text: 'Boa tarde!', emoji: 'üå§Ô∏è' };
    } else {
      return { text: 'Boa noite!', emoji: 'üåô' };
    }
  }
  
  // Fun√ß√£o para formatar hor√°rio de atendimento
  function getScheduleText() {
    if (!config.enabled) {
      return 'Resposta em at√© 2 horas durante hor√°rio comercial';
    }
    
    var now = getCurrentTime();
    var day = now.getDay();
    
    if (day === 0 && !config.sundayEnabled) {
      return 'Fechado aos domingos. Retornamos na segunda-feira √†s ' + config.weekdayStart;
    }
    
    if (day === 0) {
      return 'Hor√°rio de domingo: ' + config.sundayStart + ' √†s ' + config.sundayEnd;
    } else if (day === 6) {
      return 'Hor√°rio de s√°bado: ' + config.saturdayStart + ' √†s ' + config.saturdayEnd;
    } else {
      return 'Hor√°rio de atendimento: ' + config.weekdayStart + ' √†s ' + config.weekdayEnd;
    }
  }
  
  // Atualiza status online/offline
  function updateStatus() {
    var online = isOnline();
    var greeting = getGreeting();
    
    // Atualiza status no header
    if (online) {
      statusElement.textContent = '‚óè Online';
      statusElement.style.color = 'white';
      if (onlineIndicator) onlineIndicator.style.display = 'block';
      if (avatarOnline) avatarOnline.style.display = 'block';
    } else {
      statusElement.textContent = 'Offline';
      statusElement.style.color = 'rgba(255,255,255,0.7)';
      if (onlineIndicator) onlineIndicator.style.display = 'none';
      if (avatarOnline) avatarOnline.style.display = 'none';
    }
    
    // Atualiza sauda√ß√£o
    if (timeGreetingElement) {
      timeGreetingElement.textContent = greeting.text + ' ' + greeting.emoji;
    }
    
    // Atualiza mensagem se offline
    if (!online && config.enabled && greetingElement) {
      greetingElement.textContent = config.offlineMessage;
    }
    
    // Atualiza footer com hor√°rio
    if (footerElement) {
      footerElement.textContent = getScheduleText();
    }
  }
  
  // Atualiza status ao carregar
  updateStatus();
  
  // Atualiza status a cada minuto
  setInterval(updateStatus, 60000);
  
  // Sistema de mensagens autom√°ticas
  var typingIndicator = document.getElementById('whatsapp-typing');
  var autoMessagesContainer = document.getElementById('whatsapp-auto-messages');
  var externalTyping = document.getElementById('whatsapp-external-typing');
  var externalMessage = document.getElementById('whatsapp-external-message');
  var externalText = document.getElementById('whatsapp-external-text');
  var externalTime = document.getElementById('whatsapp-external-time');
  var externalClose = document.getElementById('whatsapp-external-close');
  
  // Fechar mensagem externa
  if (externalClose) {
    externalClose.addEventListener('click', function(e) {
      e.stopPropagation();
      hideExternalMessage();
    });
  }
  
  function showExternalTyping() {
    if (externalTyping) {
      externalTyping.classList.add('show');
    }
  }
  
  function hideExternalTyping() {
    if (externalTyping) {
      externalTyping.classList.remove('show');
    }
  }
  
  function showExternalMessage(message) {
    if (!externalMessage || !externalText || !externalTime) return;
    
    var now = getCurrentTime();
    var timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                  now.getMinutes().toString().padStart(2, '0');
    
    externalText.textContent = message;
    externalTime.textContent = timeStr;
    externalMessage.classList.add('show');
  }
  
  function hideExternalMessage() {
    if (externalMessage) {
      externalMessage.classList.remove('show');
    }
  }
  
  function showTypingIndicator() {
    if (typingIndicator) {
      typingIndicator.style.display = 'block';
      // Scroll para baixo
      if (chatBox.querySelector('.whatsapp-body')) {
        var body = chatBox.querySelector('.whatsapp-body');
        body.scrollTop = body.scrollHeight;
      }
    }
  }
  
  function hideTypingIndicator() {
    if (typingIndicator) {
      typingIndicator.style.display = 'none';
    }
  }
  
  function showAutoMessage(message) {
    if (!autoMessagesContainer) return;
    
    var messageDiv = document.createElement('div');
    messageDiv.className = 'whatsapp-auto-message';
    messageDiv.style.display = 'block';
    
    var now = getCurrentTime();
    var timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                  now.getMinutes().toString().padStart(2, '0');
    
    messageDiv.innerHTML = '<p>' + message + '</p><span class="whatsapp-auto-message-time">' + timeStr + '</span>';
    
    autoMessagesContainer.appendChild(messageDiv);
    
    // Scroll para baixo
    if (chatBox.querySelector('.whatsapp-body')) {
      var body = chatBox.querySelector('.whatsapp-body');
      setTimeout(function() {
        body.scrollTop = body.scrollHeight;
      }, 100);
    }
  }
  
  function showNextMessage() {
    if (!autoMessageConfig.enabled || autoMessages.length === 0) return;
    if (currentMessageIndex >= autoMessages.length) {
      // Terminou o ciclo, aguarda pausa
      hasShownCycle = true;
      currentMessageIndex = 0;
      
      // Salva estado: ciclo completo
      localStorage.setItem('whatsapp_cycle_state', JSON.stringify({
        index: 0,
        completed: true,
        timestamp: Date.now()
      }));
      
      // Agenda pr√≥ximo ciclo ap√≥s pausa
      cycleTimeout = setTimeout(function() {
        localStorage.removeItem('whatsapp_cycle_state');
        hasShownCycle = false;
        startMessageCycle();
      }, autoMessageConfig.pauseAfterCycle);
      
      return;
    }
    
    // Salva estado atual antes de mostrar mensagem
    localStorage.setItem('whatsapp_cycle_state', JSON.stringify({
      index: currentMessageIndex,
      completed: false,
      timestamp: Date.now()
    }));
    
    // Se chat estiver aberto, mostra dentro do chat
    var isChatOpen = chatBox.classList.contains('active');
    
    if (isChatOpen) {
      // Mostra indicador de digita√ß√£o interno
      showTypingIndicator();
      
      // Ap√≥s dura√ß√£o de digita√ß√£o, mostra mensagem
      messageTimeout = setTimeout(function() {
        hideTypingIndicator();
        showAutoMessage(autoMessages[currentMessageIndex]);
        currentMessageIndex++;
        
        // Agenda pr√≥xima mensagem
        messageTimeout = setTimeout(function() {
          showNextMessage();
        }, autoMessageConfig.interval);
        
      }, autoMessageConfig.typingDuration);
    } else {
      // Mostra bal√£o externo (fora do chat)
      hideExternalMessage(); // Esconde mensagem anterior
      showExternalTyping();
      
      // Ap√≥s dura√ß√£o de digita√ß√£o, mostra mensagem externa
      messageTimeout = setTimeout(function() {
        hideExternalTyping();
        showExternalMessage(autoMessages[currentMessageIndex]);
        currentMessageIndex++;
        
        // Agenda pr√≥xima mensagem (esconde bal√£o antes)
        messageTimeout = setTimeout(function() {
          hideExternalMessage();
          
          // Aguarda um pouco antes da pr√≥xima
          setTimeout(function() {
            showNextMessage();
          }, 1000);
          
        }, autoMessageConfig.interval);
        
      }, autoMessageConfig.typingDuration);
    }
  }
  
  function startMessageCycle() {
    if (!autoMessageConfig.enabled || autoMessages.length === 0) return;
    
    // Limpa mensagens anteriores do chat
    if (autoMessagesContainer) {
      autoMessagesContainer.innerHTML = '';
    }
    
    currentMessageIndex = 0;
    showNextMessage();
  }
  
  function stopMessageCycle() {
    if (cycleTimeout) clearTimeout(cycleTimeout);
    if (messageTimeout) clearTimeout(messageTimeout);
    hideTypingIndicator();
    hideExternalTyping();
    hideExternalMessage();
    // N√£o limpa localStorage aqui para manter estado ao recarregar
  }
  
  // Inicia ciclo automaticamente ap√≥s 3 segundos (sem precisar abrir chat)
  // S√≥ inicia se n√£o completou o ciclo ou se passou o tempo de pausa
  if (autoMessageConfig.enabled && autoMessages.length > 0) {
    if (!hasShownCycle) {
      // N√£o completou ainda, continua de onde parou
      var delayTime = currentMessageIndex === 0 ? 3000 : 1000; // 3s na primeira, 1s nas demais
      setTimeout(function() {
        showNextMessage();
      }, delayTime);
    } else {
      // Completou, agenda para quando a pausa terminar
      var state = JSON.parse(localStorage.getItem('whatsapp_cycle_state') || '{}');
      if (state.completed && state.timestamp) {
        var timeRemaining = autoMessageConfig.pauseAfterCycle - (Date.now() - state.timestamp);
        if (timeRemaining > 0) {
          cycleTimeout = setTimeout(function() {
            localStorage.removeItem('whatsapp_cycle_state');
            hasShownCycle = false;
            currentMessageIndex = 0;
            startMessageCycle();
          }, timeRemaining);
        } else {
          // Pausa j√° passou, reinicia
          localStorage.removeItem('whatsapp_cycle_state');
          hasShownCycle = false;
          currentMessageIndex = 0;
          setTimeout(function() {
            startMessageCycle();
          }, 3000);
        }
      }
    }
  }
  
  // Toggle chat
  toggle.addEventListener('click', function() {
    var isActive = chatBox.classList.contains('active');
    
    if (isActive) {
      chatBox.classList.remove('active');
      toggle.classList.remove('active');
      whatsappIcon.style.display = 'block';
      closeIcon.style.display = 'none';
    } else {
      chatBox.classList.add('active');
      toggle.classList.add('active');
      whatsappIcon.style.display = 'none';
      closeIcon.style.display = 'block';
      updateStatus(); // Atualiza ao abrir
      
      // Esconde bal√µes externos ao abrir chat
      hideExternalMessage();
      hideExternalTyping();
    }
  });
  
  // Close button
  closeBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    chatBox.classList.remove('active');
    toggle.classList.remove('active');
    whatsappIcon.style.display = 'block';
    closeIcon.style.display = 'none';
  });
  
  // Send message
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    var message = messageInput.value.trim();
    if (message) {
      var url = whatsappNumber + '?text=' + encodeURIComponent(message);
      window.open(url, '_blank');
      messageInput.value = '';
    }
  });
  
  // Modais de Rastreio e Frete
  var trackingModal = document.getElementById('whatsapp-tracking-modal');
  var shippingModal = document.getElementById('whatsapp-shipping-modal');
  var trackingBtn = document.getElementById('whatsapp-tracking-btn');
  var shippingBtn = document.getElementById('whatsapp-shipping-btn');
  
  // Abrir modais
  if (trackingBtn) {
    trackingBtn.addEventListener('click', function(e) {
      e.preventDefault();
      trackingModal.classList.add('active');
    });
  }
  
  if (shippingBtn) {
    shippingBtn.addEventListener('click', function(e) {
      e.preventDefault();
      shippingModal.classList.add('active');
    });
  }
  
  // Fechar modais
  document.querySelectorAll('.whatsapp-modal-close').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var modal = this.getAttribute('data-modal');
      if (modal === 'tracking') {
        trackingModal.classList.remove('active');
      } else if (modal === 'shipping') {
        shippingModal.classList.remove('active');
      }
    });
  });
  
  // Fechar ao clicar fora
  [trackingModal, shippingModal].forEach(function(modal) {
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    }
  });
  
  // Rastreamento
  var trackingForm = document.getElementById('tracking-form');
  if (trackingForm) {
    trackingForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      var code = document.getElementById('tracking-code').value.trim().toUpperCase();
      var loading = document.getElementById('tracking-loading');
      var result = document.getElementById('tracking-result');
      var error = document.getElementById('tracking-error');
      
      // Limpa resultados anteriores
      result.classList.remove('show');
      error.classList.remove('show');
      result.innerHTML = '';
      error.textContent = '';
      
      // Mostra loading
      loading.classList.add('show');
      
      // URL da API do Google Sheets (mesma do frete)
      var sheetsApiUrl = '{{ settings.sheets_frete_url }}';
      
      if (!sheetsApiUrl || sheetsApiUrl === '') {
        loading.classList.remove('show');
        error.textContent = 'API n√£o configurada. Configure em: Temas > C√°lculo de Frete > URL da API.';
        error.classList.add('show');
        return;
      }
      
      // Chama API com par√¢metro codigo
      var url = sheetsApiUrl + '?codigo=' + encodeURIComponent(code);
      
      fetch(url)
        .then(function(response) {
          if (!response.ok) {
            throw new Error('Erro na API: ' + response.status);
          }
          return response.json();
        })
        .then(function(data) {
          console.log('Resposta rastreamento:', data);
          loading.classList.remove('show');
          
          if (data.success === false || data.error) {
            error.textContent = data.error || 'C√≥digo de rastreio n√£o encontrado.';
            error.classList.add('show');
            return;
          }
          
          if (!data.eventos || data.eventos.length === 0) {
            error.textContent = 'Nenhuma informa√ß√£o de rastreamento dispon√≠vel.';
            error.classList.add('show');
            return;
          }
          
          var html = '<h4>Status do Pedido</h4>';
          data.eventos.forEach(function(evento) {
            html += '<div class="whatsapp-tracking-status">';
            html += '<div class="whatsapp-tracking-date">' + evento.data + ' - ' + evento.hora + '</div>';
            html += '<div class="whatsapp-tracking-text">' + evento.status + '</div>';
            if (evento.local || evento.cidade) {
              var localizacao = [];
              if (evento.local) localizacao.push(evento.local);
              if (evento.cidade) localizacao.push(evento.cidade);
              html += '<div class="whatsapp-tracking-text" style="font-size: 12px; color: #9ca3af; margin-top: 4px;">' + localizacao.join(' - ') + '</div>';
            }
            html += '</div>';
          });
          
          result.innerHTML = html;
          result.classList.add('show');
        })
        .catch(function(err) {
          loading.classList.remove('show');
          console.error('Erro no rastreamento:', err);
          error.textContent = 'Erro ao buscar rastreamento. Verifique o c√≥digo e tente novamente.';
          error.classList.add('show');
        });
    });
  }
  
  // C√°lculo de Frete
  var shippingForm = document.getElementById('shipping-form');
  if (shippingForm) {
    shippingForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      var cepFormatado = document.getElementById('shipping-cep').value; // Com h√≠fen
      var cep = cepFormatado.replace(/\D/g, ''); // Sem h√≠fen para valida√ß√£o
      var loading = document.getElementById('shipping-loading');
      var result = document.getElementById('shipping-result');
      var error = document.getElementById('shipping-error');
      
      if (cep.length !== 8) {
        error.textContent = 'CEP inv√°lido. Digite um CEP v√°lido.';
        error.classList.add('show');
        return;
      }
      
      // Limpa resultados anteriores
      result.classList.remove('show');
      error.classList.remove('show');
      result.innerHTML = '';
      error.textContent = '';
      
      // Mostra loading
      loading.classList.add('show');
      
      // URL da API do Google Sheets configurada
      var sheetsApiUrl = '{{ settings.sheets_frete_url }}';
      var cepOrigem = '{{ settings.correios_cep_origem | default: "74550050" }}'; // CEP de origem
      
      if (!sheetsApiUrl || sheetsApiUrl === '') {
        loading.classList.remove('show');
        error.textContent = 'API de frete n√£o configurada. Configure em: Temas > C√°lculo de Frete > URL da API.';
        error.classList.add('show');
        return;
      }
      
      // Remove h√≠fen dos CEPs para enviar √† API
      var cepOrigemLimpo = cepOrigem.replace(/\D/g, '');
      var cepDestinoLimpo = cep; // J√° est√° sem h√≠fen
      
      // Par√¢metros conforme esperado pelo script do Google Sheets
      // O script espera: cep ou destination_cep, cep_origem ou origin_cep, peso ou cart_weight
      var params = {
        cep: cepDestinoLimpo,
        cep_origem: cepOrigemLimpo,
        peso: 0.5 // peso em kg
      };
      
      // Monta URL com par√¢metros
      var url = sheetsApiUrl + '?';
      for (var key in params) {
        url += key + '=' + encodeURIComponent(params[key]) + '&';
      }
      url = url.slice(0, -1); // Remove √∫ltimo &
      
      // Chama API do Google Sheets
      fetch(url)
        .then(function(response) {
          if (!response.ok) {
            console.error('Erro HTTP:', response.status);
            throw new Error('Erro na API: ' + response.status);
          }
          return response.json();
        })
        .then(function(data) {
          console.log('Resposta da API:', data); // Debug
          loading.classList.remove('show');
          
          // Verifica se houve erro
          if (data.success === false || data.error) {
            var mensagemErro = data.error || 'N√£o foi poss√≠vel calcular o frete para este CEP.';
            error.textContent = mensagemErro;
            error.classList.add('show');
            return;
          }
          
          // Verifica se tem op√ß√µes de frete
          if (!data.options || data.options.length === 0) {
            error.textContent = 'Nenhum servi√ßo de frete dispon√≠vel para este CEP.';
            error.classList.add('show');
            return;
          }
          
          // Busca informa√ß√µes do CEP para mostrar cidade
          fetch('https://viacep.com.br/ws/' + cep + '/json/')
            .then(function(r) { return r.json(); })
            .then(function(cepData) {
              var cidade = cepData.localidade || '';
              var uf = cepData.uf || '';
              
              var html = '<h4>Op√ß√µes de Frete';
              if (cidade && uf) {
                html += ' para ' + cidade + ' - ' + uf;
              }
              html += '</h4>';
              
              // Processa cada op√ß√£o de frete
              data.options.forEach(function(option) {
                var nome = option.name || 'Correios';
                var valor = parseFloat(option.price || 0);
                var prazo = option.estimated_days || 'Consultar';
                
                html += '<div class="whatsapp-shipping-option">';
                html += '<div>';
                html += '<div class="whatsapp-shipping-name">' + nome + '</div>';
                html += '<div class="whatsapp-shipping-time">' + prazo + '</div>';
                html += '</div>';
                html += '<div class="whatsapp-shipping-price">R$ ' + valor.toFixed(2).replace('.', ',') + '</div>';
                html += '</div>';
              });
              
              html += '<p style="font-size: 11px; color: #9ca3af; margin-top: 12px; text-align: center;">Valores calculados pelos Correios</p>';
              
              result.innerHTML = html;
              result.classList.add('show');
            })
            .catch(function() {
              // Se falhar buscar CEP, mostra sem cidade
              var html = '<h4>Op√ß√µes de Frete</h4>';
              
              data.options.forEach(function(option) {
                var nome = option.name || 'Correios';
                var valor = parseFloat(option.price || 0);
                var prazo = option.estimated_days || 'Consultar';
                
                html += '<div class="whatsapp-shipping-option">';
                html += '<div>';
                html += '<div class="whatsapp-shipping-name">' + nome + '</div>';
                html += '<div class="whatsapp-shipping-time">' + prazo + '</div>';
                html += '</div>';
                html += '<div class="whatsapp-shipping-price">R$ ' + valor.toFixed(2).replace('.', ',') + '</div>';
                html += '</div>';
              });
              
              html += '<p style="font-size: 11px; color: #9ca3af; margin-top: 12px; text-align: center;">Valores calculados pelos Correios</p>';
              
              result.innerHTML = html;
              result.classList.add('show');
            });
        })
        .catch(function(err) {
          loading.classList.remove('show');
          console.error('Erro no c√°lculo de frete:', err);
          error.textContent = 'Erro ao calcular frete. Verifique a configura√ß√£o da API ou tente novamente.';
          error.classList.add('show');
        });
    });
  }
  
  // M√°scara de CEP
  var cepInput = document.getElementById('shipping-cep');
  if (cepInput) {
    cepInput.addEventListener('input', function(e) {
      var value = e.target.value.replace(/\D/g, '');
      if (value.length > 5) {
        value = value.substring(0, 5) + '-' + value.substring(5, 8);
      }
      e.target.value = value;
    });
  }
  
})();
</script>
