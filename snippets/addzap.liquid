{%- comment -%}
  WhatsApp Chat Widget Moderno
  Com op√ß√µes de rastreio e c√°lculo de frete
{%- endcomment -%}

<style>
:root {
  --whatsapp-primary: {{ settings.colorzap | default: '#7c3aed' }};
  --whatsapp-bg: #f5f5f5;
  --whatsapp-text: #4a5568;
}

.whatsapp-widget {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* Bot√£o Flutuante */
.whatsapp-float-btn {
  width: 60px;
  height: 60px;
  background: var(--whatsapp-primary);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  transition: all 0.3s;
  position: relative;
}

.whatsapp-float-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 25px rgba(0,0,0,0.3);
}

.whatsapp-float-btn svg {
  width: 32px;
  height: 32px;
  fill: white;
}

.whatsapp-float-btn.active {
  background: #ef4444;
}

/* Indicador Online */
.whatsapp-online-indicator {
  position: absolute;
  bottom: 2px;
  right: 2px;
  width: 16px;
  height: 16px;
  background: #10b981;
  border: 3px solid white;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Chat Box */
.whatsapp-chat-box {
  position: absolute;
  bottom: 80px;
  right: 0;
  width: 360px;
  max-height: 550px;
  background: white;
  border-radius: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  opacity: 0;
  visibility: hidden;
  transform: translateY(20px);
  transition: all 0.3s;
}

.whatsapp-chat-box.active {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

/* Header */
.whatsapp-header {
  background: var(--whatsapp-primary);
  padding: 20px;
  border-radius: 20px 20px 0 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  color: white;
}

.whatsapp-header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.whatsapp-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.whatsapp-avatar svg {
  width: 28px;
  height: 28px;
  fill: var(--whatsapp-primary);
}

.whatsapp-avatar-online {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 14px;
  height: 14px;
  background: #10b981;
  border: 2px solid var(--whatsapp-primary);
  border-radius: 50%;
}

.whatsapp-header-info h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.whatsapp-header-info p {
  margin: 2px 0 0 0;
  font-size: 12px;
  opacity: 0.9;
}

.whatsapp-close-btn {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  padding: 5px;
  font-size: 24px;
  line-height: 1;
  opacity: 0.9;
  transition: opacity 0.2s;
}

.whatsapp-close-btn:hover {
  opacity: 1;
}

/* Body */
.whatsapp-body {
  padding: 20px;
  max-height: 350px;
  overflow-y: auto;
}

/* Mensagem de Boas-vindas */
.whatsapp-welcome-message {
  background: #f3f4f6;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 20px;
  position: relative;
}

.whatsapp-welcome-message::before {
  content: 'üëã';
  font-size: 24px;
  position: absolute;
  top: -10px;
  left: 15px;
}

.whatsapp-welcome-message p {
  margin: 0;
  font-size: 14px;
  color: var(--whatsapp-text);
  line-height: 1.5;
}

.whatsapp-welcome-time {
  display: block;
  font-size: 11px;
  color: #9ca3af;
  margin-top: 8px;
  text-align: right;
}

/* Bot√µes de A√ß√£o */
.whatsapp-action-buttons {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 20px;
}

.whatsapp-action-btn {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
  color: var(--whatsapp-text);
}

.whatsapp-action-btn:hover {
  border-color: var(--whatsapp-primary);
  background: #faf5ff;
  transform: translateY(-2px);
}

.whatsapp-action-btn-icon {
  width: 40px;
  height: 40px;
  background: #f3f4f6;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 8px;
}

.whatsapp-action-btn-icon svg {
  width: 20px;
  height: 20px;
  fill: var(--whatsapp-primary);
}

.whatsapp-action-btn-title {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 4px;
}

.whatsapp-action-btn-subtitle {
  font-size: 11px;
  color: #9ca3af;
}

/* Input de Mensagem */
.whatsapp-input-wrapper {
  padding: 15px 20px 20px;
  border-top: 1px solid #e5e7eb;
}

.whatsapp-input-form {
  display: flex;
  gap: 10px;
}

.whatsapp-input {
  flex: 1;
  padding: 12px 16px;
  border: 1px solid #e5e7eb;
  border-radius: 25px;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s;
}

.whatsapp-input:focus {
  border-color: var(--whatsapp-primary);
}

.whatsapp-send-btn {
  width: 45px;
  height: 45px;
  background: var(--whatsapp-primary);
  border: none;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.whatsapp-send-btn:hover {
  transform: scale(1.05);
}

.whatsapp-send-btn svg {
  width: 20px;
  height: 20px;
  fill: white;
}

/* Footer */
.whatsapp-footer {
  padding: 12px 20px;
  text-align: center;
  font-size: 11px;
  color: #9ca3af;
  border-top: 1px solid #e5e7eb;
}

/* Mobile */
@media (max-width: 640px) {
  .whatsapp-widget {
    bottom: 15px;
    right: 15px;
  }
  
  .whatsapp-chat-box {
    width: calc(100vw - 30px);
    max-width: 360px;
  }
  
  .whatsapp-float-btn {
    width: 55px;
    height: 55px;
  }
  
  .whatsapp-float-btn svg {
    width: 28px;
    height: 28px;
  }
}

/* Scrollbar */
.whatsapp-body::-webkit-scrollbar {
  width: 6px;
}

.whatsapp-body::-webkit-scrollbar-track {
  background: #f3f4f6;
}

.whatsapp-body::-webkit-scrollbar-thumb {
  background: #d1d5db;
  border-radius: 3px;
}

.whatsapp-body::-webkit-scrollbar-thumb:hover {
  background: #9ca3af;
}
</style>

<div class="whatsapp-widget">
  <!-- Bot√£o Flutuante -->
  <div class="whatsapp-float-btn" id="whatsapp-toggle">
    {% if settings.show_online_icon %}
      <div class="whatsapp-online-indicator"></div>
    {% endif %}
    
    <svg class="whatsapp-icon" viewBox="0 0 24 24">
      <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
    </svg>
    
    <svg class="whatsapp-close-icon" viewBox="0 0 24 24" style="display: none;">
      <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
    </svg>
  </div>

  <!-- Chat Box -->
  <div class="whatsapp-chat-box" id="whatsapp-chat">
    <!-- Header -->
    <div class="whatsapp-header">
      <div class="whatsapp-header-left">
        <div class="whatsapp-avatar">
          {% if settings.zap_img_type == 'img' and settings.zap_img %}
            <img src="{{ settings.zap_img | img_url: '100x' }}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
          {% else %}
            <svg viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
            </svg>
          {% endif %}
          {% if settings.show_online_icon %}
            <div class="whatsapp-avatar-online"></div>
          {% endif %}
        </div>
        <div class="whatsapp-header-info">
          <h3>{{ settings.titlezap | default: 'Atendimento' }}</h3>
          <p id="whatsapp-status">‚óè Online</p>
        </div>
      </div>
      <button class="whatsapp-close-btn" id="whatsapp-close">√ó</button>
    </div>

    <!-- Body -->
    <div class="whatsapp-body">
      <!-- Mensagem de Boas-vindas -->
      <div class="whatsapp-welcome-message">
        <p id="whatsapp-greeting">{{ settings.chatzap | default: 'Ol√°! Bem-vindo. Como posso ajudar voc√™ hoje?' }}</p>
        <span class="whatsapp-welcome-time" id="whatsapp-time-greeting">Boa noite! üëç</span>
      </div>

      <!-- Bot√µes de A√ß√£o -->
      <div class="whatsapp-action-buttons">
        {% if settings.whatsapp_show_tracking %}
        <a href="{{ settings.numberzap }}?text={{ settings.whatsapp_tracking_message | url_encode }}" target="_blank" class="whatsapp-action-btn">
          <div class="whatsapp-action-btn-icon">
            <svg viewBox="0 0 24 24">
              <path d="M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
            </svg>
          </div>
          <div class="whatsapp-action-btn-title">Rastrear</div>
          <div class="whatsapp-action-btn-subtitle">Meu pedido</div>
        </a>
        {% endif %}
        
        {% if settings.whatsapp_show_shipping %}
        <a href="{{ settings.numberzap }}?text={{ settings.whatsapp_shipping_message | url_encode }}" target="_blank" class="whatsapp-action-btn">
          <div class="whatsapp-action-btn-icon">
            <svg viewBox="0 0 24 24">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
            </svg>
          </div>
          <div class="whatsapp-action-btn-title">Calcular</div>
          <div class="whatsapp-action-btn-subtitle">Frete</div>
        </a>
        {% endif %}
      </div>
    </div>

    <!-- Input -->
    <div class="whatsapp-input-wrapper">
      <form class="whatsapp-input-form" id="whatsapp-form">
        <input 
          type="text" 
          class="whatsapp-input" 
          id="whatsapp-message"
          placeholder="{{ settings.digizap | default: 'Digite sua mensagem...' }}"
        >
        <button type="submit" class="whatsapp-send-btn">
          <svg viewBox="0 0 24 24">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </form>
    </div>

    <!-- Footer -->
    <div class="whatsapp-footer" id="whatsapp-footer">
      Resposta em at√© 2 horas durante hor√°rio comercial
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  var toggle = document.getElementById('whatsapp-toggle');
  var chatBox = document.getElementById('whatsapp-chat');
  var closeBtn = document.getElementById('whatsapp-close');
  var form = document.getElementById('whatsapp-form');
  var messageInput = document.getElementById('whatsapp-message');
  var whatsappIcon = toggle.querySelector('.whatsapp-icon');
  var closeIcon = toggle.querySelector('.whatsapp-close-icon');
  var statusElement = document.getElementById('whatsapp-status');
  var greetingElement = document.getElementById('whatsapp-greeting');
  var timeGreetingElement = document.getElementById('whatsapp-time-greeting');
  var footerElement = document.getElementById('whatsapp-footer');
  var onlineIndicator = toggle.querySelector('.whatsapp-online-indicator');
  var avatarOnline = chatBox.querySelector('.whatsapp-avatar-online');
  
  var whatsappNumber = '{{ settings.numberzap }}';
  
  // Configura√ß√µes de hor√°rio
  var config = {
    enabled: {{ settings.whatsapp_schedule_enabled | default: false | json }},
    timezone: {{ settings.whatsapp_timezone | default: -3 | json }}, // UTC offset
    weekdayStart: '{{ settings.whatsapp_weekday_start | default: "09:00" }}',
    weekdayEnd: '{{ settings.whatsapp_weekday_end | default: "18:00" }}',
    saturdayStart: '{{ settings.whatsapp_saturday_start | default: "09:00" }}',
    saturdayEnd: '{{ settings.whatsapp_saturday_end | default: "13:00" }}',
    sundayEnabled: {{ settings.whatsapp_sunday_enabled | default: false | json }},
    sundayStart: '{{ settings.whatsapp_sunday_start | default: "09:00" }}',
    sundayEnd: '{{ settings.whatsapp_sunday_end | default: "13:00" }}',
    offlineMessage: '{{ settings.whatsapp_offline_message | default: "No momento estamos offline. Deixe sua mensagem!" }}'
  };
  
  // Fun√ß√£o para obter hor√°rio atual
  function getCurrentTime() {
    var now = new Date();
    var utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    var localTime = new Date(utc + (3600000 * config.timezone));
    return localTime;
  }
  
  // Fun√ß√£o para verificar se est√° no hor√°rio de atendimento
  function isOnline() {
    if (!config.enabled) return true; // Se n√£o configurado, sempre online
    
    var now = getCurrentTime();
    var day = now.getDay(); // 0 = Domingo, 6 = S√°bado
    var currentTime = now.getHours() * 60 + now.getMinutes();
    
    var start, end;
    
    // Domingo
    if (day === 0) {
      if (!config.sundayEnabled) return false;
      start = timeToMinutes(config.sundayStart);
      end = timeToMinutes(config.sundayEnd);
    }
    // S√°bado
    else if (day === 6) {
      start = timeToMinutes(config.saturdayStart);
      end = timeToMinutes(config.saturdayEnd);
    }
    // Segunda a Sexta
    else {
      start = timeToMinutes(config.weekdayStart);
      end = timeToMinutes(config.weekdayEnd);
    }
    
    return currentTime >= start && currentTime <= end;
  }
  
  // Converte hora (HH:MM) para minutos
  function timeToMinutes(time) {
    var parts = time.split(':');
    return parseInt(parts[0]) * 60 + parseInt(parts[1]);
  }
  
  // Fun√ß√£o para obter sauda√ß√£o baseada no hor√°rio
  function getGreeting() {
    var now = getCurrentTime();
    var hour = now.getHours();
    
    if (hour >= 6 && hour < 12) {
      return { text: 'Bom dia!', emoji: '‚òÄÔ∏è' };
    } else if (hour >= 12 && hour < 18) {
      return { text: 'Boa tarde!', emoji: 'üå§Ô∏è' };
    } else {
      return { text: 'Boa noite!', emoji: 'üåô' };
    }
  }
  
  // Fun√ß√£o para formatar hor√°rio de atendimento
  function getScheduleText() {
    if (!config.enabled) {
      return 'Resposta em at√© 2 horas durante hor√°rio comercial';
    }
    
    var now = getCurrentTime();
    var day = now.getDay();
    
    if (day === 0 && !config.sundayEnabled) {
      return 'Fechado aos domingos. Retornamos na segunda-feira √†s ' + config.weekdayStart;
    }
    
    if (day === 0) {
      return 'Hor√°rio de domingo: ' + config.sundayStart + ' √†s ' + config.sundayEnd;
    } else if (day === 6) {
      return 'Hor√°rio de s√°bado: ' + config.saturdayStart + ' √†s ' + config.saturdayEnd;
    } else {
      return 'Hor√°rio de atendimento: ' + config.weekdayStart + ' √†s ' + config.weekdayEnd;
    }
  }
  
  // Atualiza status online/offline
  function updateStatus() {
    var online = isOnline();
    var greeting = getGreeting();
    
    // Atualiza status no header
    if (online) {
      statusElement.textContent = '‚óè Online';
      statusElement.style.color = 'white';
      if (onlineIndicator) onlineIndicator.style.display = 'block';
      if (avatarOnline) avatarOnline.style.display = 'block';
    } else {
      statusElement.textContent = 'Offline';
      statusElement.style.color = 'rgba(255,255,255,0.7)';
      if (onlineIndicator) onlineIndicator.style.display = 'none';
      if (avatarOnline) avatarOnline.style.display = 'none';
    }
    
    // Atualiza sauda√ß√£o
    if (timeGreetingElement) {
      timeGreetingElement.textContent = greeting.text + ' ' + greeting.emoji;
    }
    
    // Atualiza mensagem se offline
    if (!online && config.enabled && greetingElement) {
      greetingElement.textContent = config.offlineMessage;
    }
    
    // Atualiza footer com hor√°rio
    if (footerElement) {
      footerElement.textContent = getScheduleText();
    }
  }
  
  // Atualiza status ao carregar
  updateStatus();
  
  // Atualiza status a cada minuto
  setInterval(updateStatus, 60000);
  
  // Toggle chat
  toggle.addEventListener('click', function() {
    var isActive = chatBox.classList.contains('active');
    
    if (isActive) {
      chatBox.classList.remove('active');
      toggle.classList.remove('active');
      whatsappIcon.style.display = 'block';
      closeIcon.style.display = 'none';
    } else {
      chatBox.classList.add('active');
      toggle.classList.add('active');
      whatsappIcon.style.display = 'none';
      closeIcon.style.display = 'block';
      updateStatus(); // Atualiza ao abrir
    }
  });
  
  // Close button
  closeBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    chatBox.classList.remove('active');
    toggle.classList.remove('active');
    whatsappIcon.style.display = 'block';
    closeIcon.style.display = 'none';
  });
  
  // Send message
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    var message = messageInput.value.trim();
    if (message) {
      var url = whatsappNumber + '?text=' + encodeURIComponent(message);
      window.open(url, '_blank');
      messageInput.value = '';
    }
  });
  
})();
</script>
